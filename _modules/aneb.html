
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>aneb &#8212; Squid 2.0.35 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Squid 2.0.35 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for aneb</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Auto ANEB module simplifies the submission of Auto Nudged Elastic Band simulations.</span>

<span class="sd">NOTE! This module is still in a very rough beta.  It has been hacked together from the</span>
<span class="sd">NEB module and is being tested.  Do not use this expecting a miracle.</span>

<span class="sd">The following code has been tested out to some moderate success for now:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    new_opt_params = {&#39;step_size&#39;: 1.0,</span>
<span class="sd">                      &#39;step_size_adjustment&#39;: 0.5,</span>
<span class="sd">                      &#39;max_step&#39;: 0.04,</span>
<span class="sd">                      &#39;maxiter&#39;: 100,</span>
<span class="sd">                      &#39;linesearch&#39;: None,</span>
<span class="sd">                      &#39;accelerate&#39;: False,</span>
<span class="sd">                      &#39;N_reset_hess&#39;: 10,</span>
<span class="sd">                      &#39;max_steps_remembered&#39;: 5,</span>
<span class="sd">                      &#39;fit_rigid&#39;: True,</span>
<span class="sd">                      &#39;g_rms&#39;: units.convert(&quot;eV/Ang&quot;, &quot;Ha/Ang&quot;, 0.001),</span>
<span class="sd">                      &#39;g_max&#39;: units.convert(&quot;eV/Ang&quot;, &quot;Ha/Ang&quot;, 0.03)}</span>

<span class="sd">    new_auto_opt_params = {&#39;step_size&#39;: 1.0,</span>
<span class="sd">                           &#39;step_size_adjustment&#39;: 0.5,</span>
<span class="sd">                           &#39;max_step&#39;: 0.04,</span>
<span class="sd">                           &#39;maxiter&#39;: 20,</span>
<span class="sd">                           &#39;linesearch&#39;: &#39;backtrack&#39;,</span>
<span class="sd">                           &#39;accelerate&#39;: True,</span>
<span class="sd">                           &#39;reset_step_size&#39;: 20,</span>
<span class="sd">                           &#39;fit_rigid&#39;: True,</span>
<span class="sd">                           &#39;g_rms&#39;: units.convert(&quot;eV/Ang&quot;, &quot;Ha/Ang&quot;, 10.0),</span>
<span class="sd">                           &#39;g_max&#39;: units.convert(&quot;eV/Ang&quot;, &quot;Ha/Ang&quot;, 0.03)}</span>


<span class="sd">    nebs = aneb.ANEB(&quot;debug_auto&quot;, frames, &quot;!HF-3c&quot;, fit_rigid=True,</span>
<span class="sd">                     opt=&#39;LBFGS&#39;,</span>
<span class="sd">                     new_opt_params=new_opt_params,</span>
<span class="sd">                     new_auto_opt_params=new_auto_opt_params,</span>
<span class="sd">                     ci_N=3,</span>
<span class="sd">                     ANEB_Nsim=5,</span>
<span class="sd">                     ANEB_Nmax=15)</span>

<span class="sd">- :func:`g09_start_job`</span>
<span class="sd">- :func:`g09_results`</span>
<span class="sd">- :func:`orca_start_job`</span>
<span class="sd">- :func:`orca_results`</span>
<span class="sd">- :class:`ANEB`</span>

<span class="sd">------------</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># System imports</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="k">import</span> <span class="n">block_diag</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># Squid imports</span>
<span class="kn">from</span> <span class="nn">squid</span> <span class="k">import</span> <span class="n">g09</span>
<span class="kn">from</span> <span class="nn">squid</span> <span class="k">import</span> <span class="n">orca</span>
<span class="kn">from</span> <span class="nn">squid</span> <span class="k">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">squid.utils</span> <span class="k">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">squid.optimizers</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">squid.utils</span> <span class="k">import</span> <span class="n">print_helper</span>

<span class="c1"># from quick_min import quick_min</span>
<span class="c1"># from fire import fire</span>
<span class="c1"># from conjugate_gradient import conjugate_gradient</span>

<span class="c1"># from scipy.optimize import minimize</span>

<span class="kn">from</span> <span class="nn">squid.constants</span> <span class="k">import</span> <span class="n">FAIL_CONVERGENCE</span>
<span class="kn">from</span> <span class="nn">squid.constants</span> <span class="k">import</span> <span class="n">STEP_SIZE_TOO_SMALL</span>
<span class="kn">from</span> <span class="nn">squid.constants</span> <span class="k">import</span> <span class="n">MAXITER_CONVERGENCE</span>
<span class="kn">from</span> <span class="nn">squid.constants</span> <span class="k">import</span> <span class="n">G_MAX_CONVERGENCE</span>
<span class="kn">from</span> <span class="nn">squid.constants</span> <span class="k">import</span> <span class="n">G_RMS_CONVERGENCE</span>

<span class="c1"># Squid Auto Nudged Elastic Band package</span>
<span class="c1"># Currently supports g09 and orca</span>
<span class="c1"># Cite ANEB:</span>
<span class="c1">#     http://aip.scitation.org/doi/full/10.1063/1.4961868</span>
<span class="c1">#     http://scitation.aip.org/content/aip/journal/jcp/113/22/10.1063/1.1323224</span>
<span class="c1"># BFGS is the best method, cite:</span>
<span class="c1">#     http://theory.cm.utexas.edu/henkelman/pubs/sheppard08_134106.pdf</span>
<span class="c1"># Nudged Elastic Band. k for VASP is 5 eV/Angstrom, ie 0.1837 Hartree/Angstrom.</span>
<span class="c1"># Gtol of 1E-5 from scipy.bfgs package</span>


<span class="k">def</span> <span class="nf">flattened</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
    <span class="n">flattened_states</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">flattened_states</span> <span class="o">+=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">flattened_states</span>


<span class="k">def</span> <span class="nf">set_spring_atoms</span><span class="p">(</span><span class="n">ANEB</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">spring_atoms</span><span class="p">:</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">spring_atoms</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">spring_atoms</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># A list of element names</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">spring_atoms</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">spring_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                             <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">add_frame</span><span class="p">(</span><span class="n">ANEB</span><span class="p">,</span> <span class="n">skip_spring_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># Use for largest motion between frames</span>
    <span class="n">deltas</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">motion_per_frame</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">deltas</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">deltas</span><span class="p">))</span>

    <span class="c1"># Use for largest dE between frames</span>
    <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">add_by_energy</span><span class="p">:</span>
        <span class="n">index_E</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">energy_gaps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deltas_E</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">energy_gaps</span><span class="p">]</span>
            <span class="n">index_E</span> <span class="o">=</span> <span class="n">deltas_E</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">deltas_E</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">deltas_E</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">index_E</span><span class="p">)))</span>

        <span class="c1"># Force to use dE for now when available</span>
        <span class="k">if</span> <span class="n">index_E</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index_E</span>

    <span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">geometry</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>
    <span class="c1"># Deal with boundary conditions</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">new_frame</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">new_frame</span> <span class="o">+</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="c1"># Add in new spring constant</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolated frames </span><span class="si">%d</span><span class="s2"> and </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">new_frame</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span> <span class="o">=</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_frame</span> <span class="o">+</span> <span class="p">[</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># Add in new spring constant</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolated frames </span><span class="si">%d</span><span class="s2"> and </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_frame</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span> <span class="o">=</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_frame</span> <span class="o">+</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
        <span class="c1"># Add in new spring constant</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolated frames </span><span class="si">%d</span><span class="s2"> and </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Load initial coordinates into flat array for optimizer</span>
    <span class="n">low</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span> <span class="o">-</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">ANEB_Nsim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">low</span> <span class="o">+</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">ANEB_Nsim</span>

    <span class="k">if</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">):</span>
        <span class="n">high</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">ANEB_Nsim</span>

    <span class="n">ANEB</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">k_all</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ANEB</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">all_states</span><span class="p">[</span><span class="n">low</span><span class="p">:</span><span class="n">high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">ANEB</span><span class="o">.</span><span class="n">flattened_states</span> <span class="o">=</span> <span class="n">flattened</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>


<div class="viewcode-block" id="g09_start_job"><a class="viewcode-back" href="../module_docs/aneb.html#aneb.g09_start_job">[docs]</a><span class="k">def</span> <span class="nf">g09_start_job</span><span class="p">(</span><span class="n">ANEB</span><span class="p">,</span>
                  <span class="n">i</span><span class="p">,</span>
                  <span class="n">state</span><span class="p">,</span>
                  <span class="n">charge</span><span class="p">,</span>
                  <span class="n">procs</span><span class="p">,</span>
                  <span class="n">queue</span><span class="p">,</span>
                  <span class="n">initial_guess</span><span class="p">,</span>
                  <span class="n">extra_section</span><span class="p">,</span>
                  <span class="n">mem</span><span class="p">,</span>
                  <span class="n">priority</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A method for submitting a single point calculation using Gaussian09 for</span>
<span class="sd">    ANEB calculations.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        ANEB: :class:`ANEB`</span>
<span class="sd">            An ANEB container holding the main ANEB simulation</span>
<span class="sd">        i: *int*</span>
<span class="sd">            The index corresponding to which image on the frame is to be</span>
<span class="sd">            simulated.</span>
<span class="sd">        state: *list,* :class:`structures.Atom`</span>
<span class="sd">            A list of atoms describing the image on the frame associated</span>
<span class="sd">            with index *i*.</span>
<span class="sd">        charge: *int*</span>
<span class="sd">            Charge of the system.</span>
<span class="sd">        procs: *int*</span>
<span class="sd">            The number of processors to use during calculations.</span>
<span class="sd">        queue: *str*</span>
<span class="sd">            Which queue to submit the simulation to (this is queueing system</span>
<span class="sd">            dependent).</span>
<span class="sd">        initial_guess: *str*</span>
<span class="sd">            The name of a previous simulation for which we can read in a</span>
<span class="sd">            hessian.</span>
<span class="sd">        extra_section: *str*</span>
<span class="sd">            Extra settings for this DFT method.</span>
<span class="sd">        mem: *int*</span>
<span class="sd">            How many Mega Words (MW) you wish to have as dynamic memory.</span>
<span class="sd">        priority: *int*</span>
<span class="sd">            Whether to submit the job with a given priority (NBS). Not setup for</span>
<span class="sd">            this function yet.</span>

<span class="sd">    **Returns**</span>

<span class="sd">        g09_job: :class:`jobs.Job`</span>
<span class="sd">            A job container holding the g09 simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ANEB</span><span class="o">.</span><span class="n">calls_to_force</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="s1">&#39; Guess=Read&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">initial_guess</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="s1">&#39; Guess=Read&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No previous guess for first step</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">initial_guess</span>

    <span class="k">return</span> <span class="n">g09</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                   <span class="n">ANEB</span><span class="o">.</span><span class="n">theory</span> <span class="o">+</span> <span class="s1">&#39; Force&#39;</span> <span class="o">+</span> <span class="n">guess</span><span class="p">,</span>
                   <span class="n">state</span><span class="p">,</span>
                   <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                   <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span>
                   <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                   <span class="n">previous</span><span class="o">=</span><span class="n">prev</span><span class="p">,</span>
                   <span class="n">extra_section</span><span class="o">=</span><span class="n">extra_section</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span>
                   <span class="n">ANEB</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%%</span><span class="s1">d-</span><span class="si">%%</span><span class="s1">d&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">states</span><span class="p">),</span> <span class="n">i</span><span class="p">],</span>
                   <span class="n">mem</span><span class="o">=</span><span class="n">mem</span><span class="p">)</span></div>


<div class="viewcode-block" id="g09_results"><a class="viewcode-back" href="../module_docs/aneb.html#aneb.g09_results">[docs]</a><span class="k">def</span> <span class="nf">g09_results</span><span class="p">(</span><span class="n">ANEB</span><span class="p">,</span> <span class="n">step_to_use</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A method for reading in the output of Gaussian09 single point calculations</span>
<span class="sd">    for ANEB calculations. This will both (a) assign forces to the atoms stored</span>
<span class="sd">    in state and (b) return the energy and atoms.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        ANEB: :class:`ANEB`</span>
<span class="sd">            An ANEB container holding the main ANEB simulation</span>
<span class="sd">        step_to_use: *int*</span>
<span class="sd">            Which iteration in the ANEB sequence the output to be read in is on.</span>
<span class="sd">        i: *int*</span>
<span class="sd">            The index corresponding to which image on the frame is to be</span>
<span class="sd">            simulated.</span>
<span class="sd">        state: *list,* :class:`structures.Atom`</span>
<span class="sd">            A list of atoms describing the image on the frame associated with</span>
<span class="sd">            index *i*.</span>

<span class="sd">    **Returns**</span>

<span class="sd">        new_energy: *float*</span>
<span class="sd">            The energy of the system in Hartree (Ha).</span>
<span class="sd">        new_atoms: *list,* :class:`structures.Atom`</span>
<span class="sd">            A list of atoms with the forces attached in units of Hartree per</span>
<span class="sd">            Angstrom (Ha/Ang).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">g09</span><span class="o">.</span><span class="n">parse_atoms</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">step_to_use</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                             <span class="n">check_convergence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">parse_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;parse_atoms failed&#39;</span><span class="p">)</span>
    <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_atoms</span> <span class="o">=</span> <span class="n">result</span>

    <span class="c1"># Check if coordinates are aligned properly between state and new_atoms</span>
    <span class="k">def</span> <span class="nf">check_atom_coords</span><span class="p">(</span><span class="n">atoms1</span><span class="p">,</span> <span class="n">atoms2</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atoms1</span><span class="p">,</span> <span class="n">atoms2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">a2</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">precision</span> <span class="ow">or</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">a2</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">precision</span> <span class="ow">or</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">a2</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">precision</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;atoms not in same frame:&#39;</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">z</span><span class="p">,)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;vs&#39;</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">a2</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">a2</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">a2</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
                <span class="n">exit</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">check_atom_coords</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">new_atoms</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">new_atoms</span><span class="p">):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">fx</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;Ha/Bohr&#39;</span><span class="p">,</span> <span class="s1">&#39;Ha/Ang&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fx</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">fy</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;Ha/Bohr&#39;</span><span class="p">,</span> <span class="s1">&#39;Ha/Ang&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fy</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">fz</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;Ha/Bohr&#39;</span><span class="p">,</span> <span class="s1">&#39;Ha/Ang&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fz</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">fx</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">fx</span>
            <span class="n">a</span><span class="o">.</span><span class="n">fy</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">fy</span>
            <span class="n">a</span><span class="o">.</span><span class="n">fz</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">fz</span>

    <span class="k">return</span> <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_atoms</span></div>


<div class="viewcode-block" id="orca_start_job"><a class="viewcode-back" href="../module_docs/aneb.html#aneb.orca_start_job">[docs]</a><span class="k">def</span> <span class="nf">orca_start_job</span><span class="p">(</span><span class="n">ANEB</span><span class="p">,</span>
                   <span class="n">i</span><span class="p">,</span>
                   <span class="n">state</span><span class="p">,</span>
                   <span class="n">charge</span><span class="p">,</span>
                   <span class="n">procs</span><span class="p">,</span>
                   <span class="n">queue</span><span class="p">,</span>
                   <span class="n">initial_guess</span><span class="p">,</span>
                   <span class="n">extra_section</span><span class="p">,</span>
                   <span class="n">mem</span><span class="p">,</span>
                   <span class="n">priority</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A method for submitting a single point calculation using Orca for ANEB</span>
<span class="sd">    calculations.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        ANEB: :class:`ANEB`</span>
<span class="sd">            An ANEB container holding the main ANEB simulation</span>
<span class="sd">        i: *int*</span>
<span class="sd">            The index corresponding to which image on the frame is to be</span>
<span class="sd">            simulated.</span>
<span class="sd">        state: *list,* :class:`structures.Atom`</span>
<span class="sd">            A list of atoms describing the image on the frame associated with</span>
<span class="sd">            index *i*.</span>
<span class="sd">        charge: *int*</span>
<span class="sd">            Charge of the system.</span>
<span class="sd">        procs: *int*</span>
<span class="sd">            The number of processors to use during calculations.</span>
<span class="sd">        queue: *str*</span>
<span class="sd">            Which queue to submit the simulation to (this is queueing system</span>
<span class="sd">            dependent).</span>
<span class="sd">        initial_guess: *str*</span>
<span class="sd">            The name of a previous simulation for which we can read in a</span>
<span class="sd">            hessian.</span>
<span class="sd">        extra_section: *str*</span>
<span class="sd">            Extra settings for this DFT method.</span>
<span class="sd">        mem: *int*</span>
<span class="sd">            How many MegaBytes (MB) of memory you have available per core.</span>
<span class="sd">        priority: *int*</span>
<span class="sd">            Whether to submit to NBS with a given priority</span>

<span class="sd">    **Returns**</span>

<span class="sd">        orca_job: :class:`jobs.Job`</span>
<span class="sd">            A job container holding the orca simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ANEB</span><span class="o">.</span><span class="n">calls_to_force</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">orca</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ANEB</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                    <span class="n">ANEB</span><span class="o">.</span><span class="n">theory</span><span class="p">,</span>
                    <span class="n">state</span><span class="p">,</span>
                    <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                    <span class="n">extra_section</span><span class="o">=</span><span class="n">extra_section</span><span class="p">,</span>
                    <span class="n">grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span>
                    <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                    <span class="n">previous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mem</span><span class="o">=</span><span class="n">mem</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="n">ANEB</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span></div>


<div class="viewcode-block" id="orca_results"><a class="viewcode-back" href="../module_docs/aneb.html#aneb.orca_results">[docs]</a><span class="k">def</span> <span class="nf">orca_results</span><span class="p">(</span><span class="n">ANEB</span><span class="p">,</span> <span class="n">step_to_use</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A method for reading in the output of Orca single point calculations for</span>
<span class="sd">    ANEB calculations. This will both (a) assign forces to the atoms stored</span>
<span class="sd">    in state and (b) return the energy and atoms.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        ANEB: :class:`ANEB`</span>
<span class="sd">            An ANEB container holding the main ANEB simulation</span>
<span class="sd">        step_to_use: *int*</span>
<span class="sd">            Which iteration in the ANEB sequence the output to be read in is on.</span>
<span class="sd">        i: *int*</span>
<span class="sd">            The index corresponding to which image on the frame is to be</span>
<span class="sd">            simulated.</span>
<span class="sd">        state: *list,* :class:`structures.Atom`</span>
<span class="sd">            A list of atoms describing the image on the frame associated with</span>
<span class="sd">            index *i*.</span>

<span class="sd">    **Returns**</span>

<span class="sd">        new_energy: *float*</span>
<span class="sd">            The energy of the system in Hartree (Ha).</span>
<span class="sd">        new_atoms: *list,* :class:`structures.Atom`</span>
<span class="sd">            A list of atoms with the forces attached in units of Hartree per</span>
<span class="sd">            Angstrom (Ha/Ang).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">read_data</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">engrad_read</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ANEB</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">step_to_use</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                                 <span class="n">force</span><span class="o">=</span><span class="s1">&#39;Ha/Ang&#39;</span><span class="p">,</span>
                                 <span class="n">pos</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">)</span>
    <span class="n">new_atoms</span><span class="p">,</span> <span class="n">new_energy</span> <span class="o">=</span> <span class="n">read_data</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">new_atoms</span><span class="p">):</span>
        <span class="n">a</span><span class="o">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">fz</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">fz</span>

    <span class="k">return</span> <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_atoms</span></div>


<span class="c1"># Class to contain working variables</span>
<div class="viewcode-block" id="ANEB"><a class="viewcode-back" href="../module_docs/aneb.html#aneb.ANEB">[docs]</a><span class="k">class</span> <span class="nc">ANEB</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A method for determining the minimum energy pathway of a reaction using</span>
<span class="sd">    DFT. Note, this method was written for atomic orbital DFT codes; however,</span>
<span class="sd">    is potentially generalizable to other programs.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        name: *str*</span>
<span class="sd">            The name of the ANEB simulation to be run.</span>
<span class="sd">        states: *list, list,* :class:`structures.Atom`</span>
<span class="sd">            A list of frames, each frame being a list of atom structures.</span>
<span class="sd">            These frames represent your reaction coordinate.</span>
<span class="sd">        theory: *str*</span>
<span class="sd">            The route line for your DFT simulation.</span>
<span class="sd">        extra_section: *str, optional*</span>
<span class="sd">            Additional parameters for your DFT simulation.</span>
<span class="sd">        initial_guess: *list, str, optional*</span>
<span class="sd">            TODO - List of strings specifying a previously run ANEB simulation,</span>
<span class="sd">            allowing restart capabilities.</span>
<span class="sd">        spring_atoms: *list, int, optional*</span>
<span class="sd">            Specify which atoms will be represented by virutal springs in the</span>
<span class="sd">            ANEB calculations. Default includes all.</span>
<span class="sd">        procs: *int, optional*</span>
<span class="sd">            The number of processors for your simulation.</span>
<span class="sd">        queue: *str, optional*</span>
<span class="sd">            Which queue you wish your simulation to run on (queueing system</span>
<span class="sd">            dependent). When None, ANEB is run locally.</span>
<span class="sd">        mem: *float, optional*</span>
<span class="sd">            Specify memory constraints (specific to your X_start_job method).</span>
<span class="sd">        priority: *int, optional*</span>
<span class="sd">            Whether to submit a DFT simulation with some given priority or not.</span>
<span class="sd">        disp: *int, optional*</span>
<span class="sd">            Specify for additional stdout information.</span>
<span class="sd">        charge: *int*</span>
<span class="sd">            Charge of the system.</span>
<span class="sd">        k: *float, optional*</span>
<span class="sd">            The spring constant for your ANEB simulation.</span>
<span class="sd">        fit_rigid: *bool, optional*</span>
<span class="sd">            Whether you want to use procrustes to minimize motion between</span>
<span class="sd">            adjacent frames (thus minimizing error due to excessive virtal</span>
<span class="sd">            spring forces).</span>
<span class="sd">        DFT: *str, optional*</span>
<span class="sd">            Specify if you wish to use the default X_start_job and X_results</span>
<span class="sd">            functions where X is either g09 or orca.</span>
<span class="sd">        opt: *str, optional*</span>
<span class="sd">            Select which optimization method you wish to use from the</span>
<span class="sd">            following: LBFGS.</span>
<span class="sd">        start_job: *func, optional*</span>
<span class="sd">            A function specifying how to submit your ANEB single point</span>
<span class="sd">            calculations.  Needed if DFT is neither orca nor g09.</span>
<span class="sd">        get_results: *func, optional*</span>
<span class="sd">            A function specifying how to read your ANEB single point</span>
<span class="sd">            calculations.  Needed if DFT is neither orca nor g09.</span>
<span class="sd">        new_opt_params: *dict, optional*</span>
<span class="sd">            Pass any additional parameters to the optimization algorithm.</span>
<span class="sd">            Note, these parameters are for the final calculation after frames</span>
<span class="sd">            have been added in.</span>
<span class="sd">        new_auto_opt_params: *dict, optional*</span>
<span class="sd">            Pass any additional parameters to the optimization algorithm.</span>
<span class="sd">            Note, these parameters are for the iterative calculations, as</span>
<span class="sd">            frames are being added to the band.</span>
<span class="sd">        callback: *func, optional*</span>
<span class="sd">            A function to be run after each each to calculate().</span>
<span class="sd">        ci_ANEB: *bool, optional*</span>
<span class="sd">            Whether to use the climbing image variation of ANEB.</span>
<span class="sd">        ci_N: *int, optional*</span>
<span class="sd">            How many iterations to wait in climbing image ANEB before selecting</span>
<span class="sd">            which image to be used.</span>
<span class="sd">        ANEB_Nsim: *int, optional*</span>
<span class="sd">            The number of frames for an auto ANEB calculation. If an even</span>
<span class="sd">            number is chosen, the expansion happens around floor(ANEB_Nsim/2).</span>
<span class="sd">        ANEB_Nmax: *int, optional*</span>
<span class="sd">            The maximum number of frames to build up to in the auto ANEB.</span>
<span class="sd">        add_by_energy: *bool, optional*</span>
<span class="sd">            If the user wants to add frames by the largest dE instead of dR</span>
<span class="sd">            (motion per frame), then set this flag to True.</span>


<span class="sd">    **Returns**</span>

<span class="sd">        This :class:`ANEB` object.</span>

<span class="sd">    **References**</span>

<span class="sd">        * Henkelman, G.; Jonsson, H. The Journal of Chemical Physics 2000,</span>
<span class="sd">          113, 9978-9985.</span>
<span class="sd">        * Jonsson, H.; Mills, G.; Jacobson, K. W. In Classical and Quantum</span>
<span class="sd">          Dynamics in Condensed Phase Simulations;</span>
<span class="sd">        * Berne, B. J., Ciccotti, G., Coker, D. F., Eds.; World Scientific,</span>
<span class="sd">          1998; Chapter 16, pp 385-404.</span>
<span class="sd">        * Armijo, L. Pacific Journal of Mathematics 1966, 16.</span>
<span class="sd">        * Sheppard, D.; Terrell, R.; Henkelman, G. The Journal of Chemical</span>
<span class="sd">          Physics 2008, 128.</span>
<span class="sd">        * Henkelman, G.; Uberuaga, B. P.; Jonsson, H. Journal of Chemical</span>
<span class="sd">          Physics 2000, 113.</span>
<span class="sd">        * Atomic Simulation Environment - https://wiki.fysik.dtu.dk/ase/</span>
<span class="sd">        * Kolsbjerg, E. L.; Groves, M. N.; Hammer, B. The Journal of </span>
<span class="sd">          Chemical Physics 2016, 145.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error</span><span class="p">,</span> <span class="n">gradient</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">theory</span><span class="p">,</span> <span class="n">extra_section</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">initial_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spring_atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">k</span><span class="o">=</span><span class="mf">0.00367453</span><span class="p">,</span>  <span class="c1"># 0.1 eV/A in Ha/A</span>
                 <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">fit_rigid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">DFT</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">&#39;LBFGS&#39;</span><span class="p">,</span>
                 <span class="n">start_job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">new_opt_params</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">new_auto_opt_params</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ci_ANEB</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">ci_N</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">ANEB_Nsim</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">ANEB_Nmax</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                 <span class="n">add_by_energy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_states</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theory</span> <span class="o">=</span> <span class="n">theory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_section</span> <span class="o">=</span> <span class="n">extra_section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">=</span> <span class="n">initial_guess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spring_atoms</span> <span class="o">=</span> <span class="n">spring_atoms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="n">procs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">priority</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">states</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_all</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_0</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DFT</span> <span class="o">=</span> <span class="n">DFT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_rigid</span> <span class="o">=</span> <span class="n">fit_rigid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_job</span> <span class="o">=</span> <span class="n">start_job</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span> <span class="o">=</span> <span class="n">get_results</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ci_ANEB</span> <span class="o">=</span> <span class="n">ci_ANEB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_img</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_N</span> <span class="o">=</span> <span class="n">ci_N</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_by_energy</span> <span class="o">=</span> <span class="n">add_by_energy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ANEB_Nsim</span> <span class="o">=</span> <span class="n">ANEB_Nsim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ANEB_Nmax</span> <span class="o">=</span> <span class="n">ANEB_Nmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_gaps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_opt_params</span> <span class="o">=</span> <span class="n">new_opt_params</span>
        <span class="k">if</span> <span class="s1">&#39;fit_rigid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_opt_params</span><span class="p">:</span>
            <span class="n">new_opt_params</span><span class="p">[</span><span class="s1">&#39;fit_rigid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_rigid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_auto_opt_params</span> <span class="o">=</span> <span class="n">new_auto_opt_params</span>
        <span class="k">if</span> <span class="s1">&#39;fit_rigid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_auto_opt_params</span><span class="p">:</span>
            <span class="n">new_auto_opt_params</span><span class="p">[</span><span class="s1">&#39;fit_rigid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_rigid</span>

        <span class="c1"># Other starting parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RMS_force</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAX_force</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAX_energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calls_to_calculate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calls_to_force</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">DFT</span> <span class="o">=</span> <span class="n">DFT</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DFT</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_job</span> <span class="o">=</span> <span class="n">orca_start_job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span> <span class="o">=</span> <span class="n">orca_results</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">DFT</span> <span class="o">==</span> <span class="s1">&#39;g09&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_job</span> <span class="o">=</span> <span class="n">g09_start_job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span> <span class="o">=</span> <span class="n">g09_results</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_job</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error - You need to either specify DFT as orca or </span><span class="se">\</span>
<span class="s2">g09.  If not, you need to manually specify start_job and get_results.&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure we have ANEB_Nsim at minimum</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ANEB_Nsim</span><span class="p">:</span>
            <span class="n">add_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_rigid</span><span class="p">:</span>
                <span class="n">geometry</span><span class="o">.</span><span class="n">procrustes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>

        <span class="c1"># In all cases, optimize the path via rigid rotations first</span>
        <span class="c1"># Set to only if fit_rigid for comparison purposes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_rigid</span><span class="p">:</span>
            <span class="n">geometry</span><span class="o">.</span><span class="n">procrustes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">all_states</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>

        <span class="c1"># Load initial coordinates into flat array for optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flattened_states</span> <span class="o">=</span> <span class="n">flattened</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>

        <span class="c1"># Raise warnings if odd starting parameters used</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_ANEB</span> <span class="ow">and</span> <span class="s2">&quot;linesearch&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_opt_params</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_opt_params</span><span class="p">[</span><span class="s2">&quot;linesearch&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING</span><span class="se">\n</span><span class="s2">You have chosen to have climbing image with a linesearch.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It is recommended to set linesearch to None, as at times this prevents the climbing image to&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;increase the energy as needed.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_ANEB</span> <span class="ow">and</span> <span class="s2">&quot;linesearch&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_opt_params</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="s2">&quot;LBFGS&quot;</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;SD&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WARNING</span><span class="se">\n</span><span class="s2">You have chosen to have climbing image.  Beware that the default parameters for the&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;optimizer you chose may have a linesearch set.  It is recommended to set linesearch to None,&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;as at times this prevents the climbing image to increase the energy as needed.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calls_to_calculate</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Update coordinates in states. This won&#39;t change anything on</span>
        <span class="c1"># the first run through, but will on subsequent ones</span>
        <span class="n">coord_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">coord_count</span><span class="p">:</span><span class="n">coord_count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="n">coord_count</span> <span class="o">+=</span> <span class="mi">3</span>

        <span class="c1"># Start DFT jobs</span>
        <span class="n">running_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># No need to calculate anything for first and last states</span>
                <span class="c1"># after the first step</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">i</span><span class="p">,</span>
                                   <span class="n">state</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">extra_section</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="c1"># Wait for jobs to finish</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">running_jobs</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c1"># Get forces and energies from DFT calculations</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">):</span>
            <span class="c1"># State 0 and state N-1 don&#39;t change, so just use result</span>
            <span class="c1"># from self.step == 0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">step_to_use</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">step_to_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>

            <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">step_to_use</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span>
            <span class="p">)</span>
            <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_energy</span><span class="p">)</span>

        <span class="c1"># V = potential energy from DFT. energies = V+springs</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

        <span class="c1"># In climbing image ANEB, after a few iterations we take the highest</span>
        <span class="c1"># energy image and use that.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_ANEB</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_img</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_N</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ci_img</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_img</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;CI found endpoint. Is your band correct?&quot;</span><span class="p">)</span>

        <span class="c1"># Get positions in a flat array</span>
        <span class="k">def</span> <span class="nf">get_positions</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">image</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spring_atoms</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">pos</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Add spring forces to atoms</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">real_force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spring_atoms</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">real_force</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">fz</span><span class="p">])</span>
            <span class="n">real_force</span> <span class="o">=</span> <span class="n">real_force</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="c1"># Find tangent</span>
            <span class="n">tplus</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">b</span>
            <span class="n">tminus</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
            <span class="n">dVmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">dVmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">tangent</span> <span class="o">=</span> <span class="n">tplus</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">tangent</span> <span class="o">=</span> <span class="n">tminus</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">tangent</span> <span class="o">=</span> <span class="n">tplus</span> <span class="o">*</span> <span class="n">dVmax</span> <span class="o">+</span> <span class="n">tminus</span> <span class="o">*</span> <span class="n">dVmin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tangent</span> <span class="o">=</span> <span class="n">tplus</span> <span class="o">*</span> <span class="n">dVmin</span> <span class="o">+</span> <span class="n">tminus</span> <span class="o">*</span> <span class="n">dVmax</span>

            <span class="c1"># Normalize tangent</span>
            <span class="n">tangent_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">tangent</span><span class="p">,</span> <span class="n">tangent</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">tangent_norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tangent</span> <span class="o">/=</span> <span class="n">tangent_norm</span>

            <span class="n">F_spring_parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tplus</span><span class="p">)</span> <span class="o">-</span>
                                                 <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tminus</span><span class="p">))</span> <span class="o">*</span> <span class="n">tangent</span>

            <span class="n">F_real_perpendicular</span> <span class="o">=</span> <span class="n">real_force</span> <span class="o">-</span>\
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">real_force</span><span class="p">,</span> <span class="n">tangent</span><span class="p">)</span> <span class="o">*</span> <span class="n">tangent</span><span class="p">)</span>

            <span class="c1"># Set ANEB forces</span>
            <span class="c1"># Note, in climbing image we have the formula:</span>
            <span class="c1">#    F = F_real - 2*F_real*tau*tau</span>
            <span class="c1"># Vs the normal:</span>
            <span class="c1">#    F = F_spring_parallel + F_real_perpendicular</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci_img</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="n">real_force</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">real_force</span><span class="p">,</span> <span class="n">tangent</span><span class="p">)</span> <span class="o">*</span> <span class="n">tangent</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="n">F_spring_parallel</span> <span class="o">+</span> <span class="n">F_real_perpendicular</span>
            <span class="n">forces</span> <span class="o">=</span> <span class="n">forces</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spring_atoms</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">fz</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># Remove net translation forces from the gradient</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_rigid</span><span class="p">:</span>
            <span class="n">net_translation_force</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">net_force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                    <span class="n">net_force</span> <span class="o">+=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">fx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">fy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">fz</span><span class="p">)</span>
                <span class="n">net_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">net_force</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                <span class="n">net_translation_force</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net_trans</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">fx</span> <span class="o">-=</span> <span class="n">net_force</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">fy</span> <span class="o">-=</span> <span class="n">net_force</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">fz</span> <span class="o">-=</span> <span class="n">net_force</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">max_translation_force</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
                <span class="s2">&quot;Ha/Ang&quot;</span><span class="p">,</span>
                <span class="s2">&quot;eV/Ang&quot;</span><span class="p">,</span>
                <span class="nb">max</span><span class="p">(</span><span class="n">net_translation_force</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_translation_force</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set gradient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="c1"># Gradient of self.error</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">+=</span> <span class="p">[</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">fx</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">fy</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">fz</span><span class="p">]</span>

        <span class="c1"># Calculate RMS Force and Max force</span>
        <span class="n">force_mags</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">fx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">fy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">fz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                      <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">state</span><span class="p">]</span>
        <span class="n">RMS_force</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">rms</span><span class="p">(</span><span class="n">force_mags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RMS_force</span> <span class="o">=</span> <span class="n">RMS_force</span>
        <span class="n">MAX_force</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">force_mags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAX_force</span> <span class="o">=</span> <span class="n">MAX_force</span>

        <span class="c1"># Print data</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">units</span><span class="o">.</span><span class="n">convert_energy</span><span class="p">(</span><span class="s2">&quot;Ha&quot;</span><span class="p">,</span> <span class="s2">&quot;kT_300&quot;</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">MAX_energy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span> <span class="o">&gt;</span> <span class="n">RMS_force</span><span class="p">:</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">print_helper</span><span class="o">.</span><span class="n">color_set</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">units</span><span class="o">.</span><span class="n">convert_energy</span><span class="p">(</span>
                    <span class="s2">&quot;Ha&quot;</span><span class="p">,</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">RMS_force</span><span class="p">)</span>
                <span class="p">),</span> <span class="s1">&#39;GREEN&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">print_helper</span><span class="o">.</span><span class="n">color_set</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">units</span><span class="o">.</span><span class="n">convert_energy</span><span class="p">(</span>
                    <span class="s2">&quot;Ha&quot;</span><span class="p">,</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">RMS_force</span><span class="p">)</span>
                <span class="p">),</span> <span class="s1">&#39;RED&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span> <span class="o">&gt;</span> <span class="n">MAX_force</span><span class="p">:</span>
            <span class="n">max_f</span> <span class="o">=</span> <span class="n">print_helper</span><span class="o">.</span><span class="n">color_set</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">units</span><span class="o">.</span><span class="n">convert_energy</span><span class="p">(</span>
                    <span class="s2">&quot;Ha&quot;</span><span class="p">,</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">MAX_force</span><span class="p">)</span>
                <span class="p">),</span> <span class="s1">&#39;GREEN&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_f</span> <span class="o">=</span> <span class="n">print_helper</span><span class="o">.</span><span class="n">color_set</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">units</span><span class="o">.</span><span class="n">convert_energy</span><span class="p">(</span>
                    <span class="s2">&quot;Ha&quot;</span><span class="p">,</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="n">MAX_force</span><span class="p">)</span>
                <span class="p">),</span> <span class="s1">&#39;RED&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span> <span class="o">&gt;</span> <span class="n">MAX_energy</span><span class="p">:</span>
            <span class="n">max_e</span> <span class="o">=</span> <span class="n">print_helper</span><span class="o">.</span><span class="n">color_set</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MAX_energy</span><span class="p">),</span> <span class="s1">&#39;GREEN&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_e</span> <span class="o">=</span> <span class="n">print_helper</span><span class="o">.</span><span class="n">color_set</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MAX_energy</span><span class="p">),</span> <span class="s1">&#39;RED&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step</span><span class="se">\t</span><span class="s2">RMS_F (eV/Ang)</span><span class="se">\t</span><span class="s2">MAX_F (eV/Ang)</span><span class="se">\t</span><span class="s2">MAX_E (kT_300)</span><span class="se">\</span>
<span class="se">\t</span><span class="s2">MAX Translational Force (eV/Ang)</span><span class="se">\t</span><span class="s2">Energies (kT_300)</span><span class="se">\n</span><span class="s2">----&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t\t</span><span class="si">%s</span><span class="se">\t\t</span><span class="si">%.4f</span><span class="s2">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">max_f</span><span class="p">,</span> <span class="n">max_e</span><span class="p">,</span> <span class="n">max_translation_force</span><span class="p">)</span> <span class="o">+</span>
              <span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="si">%7.5g</span><span class="s1"> +&#39;</span>
              <span class="o">%</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%5.1f</span><span class="s1"> &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">energy_gaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span> <span class="o">=</span> <span class="n">RMS_force</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RMS_force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span> <span class="o">=</span> <span class="n">MAX_force</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span> <span class="o">=</span> <span class="n">MAX_energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_energy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span><span class="p">)</span>

        <span class="c1"># Set error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">RMS_force</span>

        <span class="c1"># Increment step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>

    <span class="c1"># Calculate the &quot;Error&quot;. This is what we minimize in our optimization</span>
    <span class="c1"># algorithm.</span>
    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">error</span>

    <span class="c1"># Calculate the gradient.  This is negative of the force.</span>
    <span class="k">def</span> <span class="nf">get_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span>
        <span class="c1"># Set to None so it will recalculate next time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradient</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>

<div class="viewcode-block" id="ANEB.align_coordinates"><a class="viewcode-back" href="../module_docs/aneb.html#aneb.ANEB.align_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">align_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_matrix</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get a rotation matrix A that will remove rigid rotation from the</span>
<span class="sd">        new coordinates r.  Further, if another vector needs rotating by the</span>
<span class="sd">        same matrix A, it should be passed in B and will be rotated.  If</span>
<span class="sd">        a matrix also needs rotating, it can be passed as H and also be</span>
<span class="sd">        rotated.</span>

<span class="sd">        *Parameters*</span>

<span class="sd">            r: *list, float*</span>
<span class="sd">                1D array of atomic coordinates to be rotated by procrustes</span>
<span class="sd">                matrix A.</span>
<span class="sd">            B: *list, list, float, optional*</span>
<span class="sd">                A list of vectors that may also be rotated by the same matrix</span>
<span class="sd">                as *r*.</span>
<span class="sd">            H: *list, list, float, optional*</span>
<span class="sd">                A matrix that should also be rotated via:</span>
<span class="sd">                    H = R * H * R.T</span>
<span class="sd">            return_matrix: *bool, optional*</span>
<span class="sd">                Whether to also return the rotation matrix used or not.</span>

<span class="sd">        *Returns*</span>

<span class="sd">            rotations: *dict*</span>
<span class="sd">                A dictionary holding &#39;A&#39;, the rotation matrix, &#39;r&#39;, the</span>
<span class="sd">                rotated new coordinates, &#39;B&#39;, a list of all other vectors that</span>
<span class="sd">                were rotated, and &#39;H&#39;, a rotated matrix.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Prevent rotation or translation</span>
        <span class="n">coord_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">coord_count</span><span class="p">:</span><span class="n">coord_count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="n">coord_count</span> <span class="o">+=</span> <span class="mi">3</span>

        <span class="c1"># Translate and rotate each frame to fit its neighbor</span>
        <span class="c1"># Note, procrustes will change st[-1] which is fine as we need this</span>
        <span class="c1"># for spring force calculations</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">procrustes</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

        <span class="n">coord_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">coord_count</span><span class="p">:</span><span class="n">coord_count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>
                <span class="n">coord_count</span> <span class="o">+=</span> <span class="mi">3</span>

        <span class="n">C</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="k">if</span> <span class="n">B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">B</span><span class="p">:</span>
                <span class="c1"># Validation code that a 1D array here works the same way.</span>
                <span class="c1"># shape = b.shape</span>
                <span class="c1"># b2 = b.flatten().dot(R)</span>
                <span class="c1"># C.append(b2.reshape(shape))</span>
                <span class="n">C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">C</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">H</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Note, to transform the Hessian matrix, it&#39;s not like a normal</span>
            <span class="c1"># vector (as above)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">H</span> <span class="o">*</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span>

        <span class="n">return_this</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span>
                       <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
                       <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
                       <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="n">H</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">return_this</span></div>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Try seeing if ANEB was run for &lt;= 2 frames</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Only one frame in ANEB calculation. Did you mean to </span><span class="se">\</span>
<span class="s2">run an optimization instead?&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - ANEB requires at least 3 frames to run. You have </span><span class="se">\</span>
<span class="s2">entered only </span><span class="si">%d</span><span class="s2"> frames.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c1"># Set which atoms will be affected by virtual springs</span>
        <span class="n">set_spring_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># ANEB Header</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---------------------------------------------&quot;</span> <span class="o">+</span>
              <span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run_Name = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DFT Package = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">DFT</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spring Constant for ANEB: </span><span class="si">%lg</span><span class="s2"> Ha/Ang = </span><span class="si">%lg</span><span class="s2"> eV/Ang&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_0</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">convert_energy</span><span class="p">(</span><span class="s2">&quot;Ha&quot;</span><span class="p">,</span> <span class="s2">&quot;eV&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_0</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">==</span> <span class="s2">&quot;lbfgs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ci_ANEB</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_states</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ANEB_Nmax</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running for N_sim = </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> frames (N_max = </span><span class="si">%d</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ANEB_Nsim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_states</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ANEB_Nmax</span><span class="p">))</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">lbfgs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flattened_states</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">get_gradient</span><span class="p">,</span>
                          <span class="n">NEB_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">new_opt_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_auto_opt_params</span><span class="p">)</span>
                <span class="n">add_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prv_RMS</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prv_MAX_E</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
                <span class="n">set_spring_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ci_ANEB</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_states</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flattened_states</span> <span class="o">=</span> <span class="n">flattened</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_states</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running final CI-ANEB with </span><span class="si">%d</span><span class="s2"> frames&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_states</span><span class="p">))</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">lbfgs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flattened_states</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">get_gradient</span><span class="p">,</span>
                           <span class="n">NEB_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">new_opt_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">new_opt_params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ERROR - </span><span class="si">%s</span><span class="s2"> optimizations method does not exist! Choose </span><span class="se">\</span>
<span class="s2">from the following:&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">1. LBFGS&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;scipy&quot;</span><span class="p">):</span>
            <span class="n">FINAL_PARAMS</span><span class="p">,</span> <span class="n">CODE</span><span class="p">,</span> <span class="n">ITERS</span> <span class="o">=</span> <span class="n">output</span>

            <span class="k">if</span> <span class="n">CODE</span> <span class="o">==</span> <span class="n">FAIL_CONVERGENCE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ANEB failed to converge.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">CODE</span> <span class="o">==</span> <span class="n">MAXITER_CONVERGENCE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ANEB quit after reaching the specified maximum number </span><span class="se">\</span>
<span class="s2">    of iterations.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">CODE</span> <span class="o">==</span> <span class="n">G_MAX_CONVERGENCE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ANEB converged the maximum force.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">CODE</span> <span class="o">==</span> <span class="n">G_RMS_CONVERGENCE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ANEB converged the RMS force.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">CODE</span> <span class="o">==</span> <span class="n">STEP_SIZE_TOO_SMALL</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ANEB failed to converge. Step size either started too </span><span class="se">\</span>
<span class="s2">    small, or was backtracked to being too small.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Something unknown happened during ANEB optimization, and </span><span class="se">\</span>
<span class="s2">    no flag was returned.&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;---------------------------------------------</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FINAL_PARAMS</span><span class="p">,</span> <span class="n">ITERS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../squid.html">Squid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console_scripts.html">Console Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Squid 2.0.35 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Henry Herbol.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>