
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>squid.orca.job &#8212; Squid 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Squid 2.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for squid.orca.job</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">squid</span> <span class="k">import</span> <span class="n">jobs</span>
<span class="kn">import</span> <span class="nn">squid.orca.io</span> <span class="k">as</span> <span class="nn">orca_io</span>
<span class="kn">from</span> <span class="nn">squid.orca.utils</span> <span class="k">import</span> <span class="n">get_orca_obj</span>


<div class="viewcode-block" id="jobarray"><a class="viewcode-back" href="../../../module_docs/orca/job.html#squid.orca.job.jobarray">[docs]</a><span class="k">def</span> <span class="nf">jobarray</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_section</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
             <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="s2">&quot;00:30:00&quot;</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">redundancy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">previous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xhost</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">jobarray_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">allocation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">batch_serial_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_ompi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">prebash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">postbash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper to submitting various Orca simulations as a job array on a SLURM</span>
<span class="sd">    system.  This is used when there are many atomic systems, stored in a</span>
<span class="sd">    list, that need to have the same DFT calculation performed on each.</span>

<span class="sd">    Note - When requesting nprocs/ntasks/nodes, these will be per-job.  As</span>
<span class="sd">    such, do **NOT** multiply out.  For instance, if you request ntasks=4,</span>
<span class="sd">    and len(frames) = 10, you will be running 10 jobs, each with 4 tasks.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        run_name: *str*</span>
<span class="sd">            Name of the simulation to be run.</span>
<span class="sd">        route: *str*</span>
<span class="sd">            The DFT route line, containing the function, basis set, etc.</span>
<span class="sd">            Note, if route=None and previous != None, the route from</span>
<span class="sd">            the previous simulation will be used instead.</span>
<span class="sd">        frames: *list,* :class:`squid.structures.atom.Atom`</span>
<span class="sd">            Each atomic system that needs to be simulated.</span>
<span class="sd">        n_frames: *int, optional*</span>
<span class="sd">            The number of frames.</span>
<span class="sd">        extra_section: *str, optional*</span>
<span class="sd">            Additional DFT simulation parameters.  If None and previous is</span>
<span class="sd">            not None, then previous extra section is used.</span>
<span class="sd">        grad: *bool, optional*</span>
<span class="sd">            Whether to force RunTyp Gradient.</span>
<span class="sd">        queue: *str, optional*</span>
<span class="sd">            What queue to run the simulation on (queueing system dependent).</span>
<span class="sd">        walltime: *str, optional*</span>
<span class="sd">            The walltime the job is given when submitted to a queue.  Format</span>
<span class="sd">            is in day-hr:min:sec.</span>
<span class="sd">        sandbox: *bool, optional*</span>
<span class="sd">            Whether to run the job in a sandbox or not.</span>
<span class="sd">        nprocs: *int, optional*</span>
<span class="sd">            How many processors to run the simulation on.  Note, the actual</span>
<span class="sd">            number requested by orca will be nprocs * ntasks.</span>
<span class="sd">        ntasks: *int, optional*</span>
<span class="sd">            (For SLURM) The number of tasks this job will run, each task uses</span>
<span class="sd">            nprocs number of cores.  Note, the actual number requested by orca</span>
<span class="sd">            will be nprocs * ntasks.</span>
<span class="sd">        nodes: *int, optional*</span>
<span class="sd">            (For SLURM) The number of nodes this job requires.  If requesting</span>
<span class="sd">            ntasks * nprocs &lt; 24 * nodes, a warning is printed, as on MARCC</span>
<span class="sd">            each node has only 24 cores.</span>
<span class="sd">        charge: *float, optional*</span>
<span class="sd">            Charge of the system.  If this is used, then</span>
<span class="sd">            charge_and_multiplicity is ignored. If multiplicity is used,</span>
<span class="sd">            but charge is not, then default charge of 0 is chosen.</span>
<span class="sd">        multiplicity: *int, optional*</span>
<span class="sd">            Multiplicity of the system.  If this is used, then</span>
<span class="sd">            charge_and_multiplicity is ignored. If charge is used, but</span>
<span class="sd">            multiplicity is not, then default multiplicity of 1 is chosen.</span>
<span class="sd">        redundancy: *bool, optional*</span>
<span class="sd">            With redundancy on, if the job is submitted and unique_name is on,</span>
<span class="sd">            then if another job of the same name is running, a pointer to that</span>
<span class="sd">            job will instead be returned.</span>
<span class="sd">        unique_name: *bool, optional*</span>
<span class="sd">            Whether to force the requirement of a unique name or not.  NOTE! If</span>
<span class="sd">            you submit simulations from the same folder, ensure that this is</span>
<span class="sd">            True lest you have a redundancy problem! To overcome said issue,</span>
<span class="sd">            you can set redundancy to True as well (but only if the simulation</span>
<span class="sd">            is truly redundant).</span>
<span class="sd">        previous: *str, optional*</span>
<span class="sd">            Name of a previous simulation for which to try reading in</span>
<span class="sd">            information using the MORead method.</span>
<span class="sd">        mem: *float, optional*</span>
<span class="sd">            Amount of memory per processor that is available (in MB).</span>
<span class="sd">        priority: *int, optional*</span>
<span class="sd">            Priority of the simulation (queueing system dependent).  Priority</span>
<span class="sd">            ranges (in NBS) from a low of 1 (start running whenever) to a</span>
<span class="sd">            high of 255 (start running ASAP).</span>
<span class="sd">        xhost: *list, str or str, optional*</span>
<span class="sd">            Which processor to run the simulation on(queueing system</span>
<span class="sd">            dependent).</span>
<span class="sd">        jobarray_values: *str, optional*</span>
<span class="sd">            If specified, instead of indicating a range for job arrays, we</span>
<span class="sd">            will use these specific values.  For example,</span>
<span class="sd">            jobarray_values=1,2,4,5 would submit jobs, but skip the 3rd</span>
<span class="sd">            index by name.</span>
<span class="sd">        allocation: *str, optional*</span>
<span class="sd">            Whether to use a slurm allocation for this job or not.  If so,</span>
<span class="sd">            specify the name.</span>
<span class="sd">        batch_serial_jobs: *int, optional*</span>
<span class="sd">            Whether to batch jobs at N at a time (locally on serial job</span>
<span class="sd">            submission).</span>
<span class="sd">        skip_ompi: *bool, optional*</span>
<span class="sd">            At times you may wish to run orca without checking if ompi is</span>
<span class="sd">            available.  This can arise when you are submitting the job to</span>
<span class="sd">            a queueing system that will load ompi later, but right now you</span>
<span class="sd">            only have orca in the path.  If so, set skip_ompi=True.</span>
<span class="sd">        prebash: *str, optional*</span>
<span class="sd">            Code to put prior to the job_to_submit in the submission script.</span>
<span class="sd">            This should be bash code!  Note, if nothing is passed we check if</span>
<span class="sd">            a default is specified in SQUID_ORCA_PREBASH.</span>
<span class="sd">        postbash: *str, optional*</span>
<span class="sd">            Code to put after the job_to_submit in the submission script.</span>
<span class="sd">            This should be bash code!  Note, if nothing is passed we check if</span>
<span class="sd">            a default is specified in SQUID_ORCA_POSTBASH.</span>

<span class="sd">    **Returns**</span>

<span class="sd">        job: :class:`squid.jobs.container.JobObject`</span>
<span class="sd">            Teturn the job container.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;extra_section&quot;</span><span class="p">:</span> <span class="n">extra_section</span><span class="p">,</span>
        <span class="s2">&quot;grad&quot;</span><span class="p">:</span> <span class="n">grad</span><span class="p">,</span>
        <span class="s2">&quot;walltime&quot;</span><span class="p">:</span> <span class="n">walltime</span><span class="p">,</span>
        <span class="s2">&quot;sandbox&quot;</span><span class="p">:</span> <span class="n">sandbox</span><span class="p">,</span>
        <span class="s2">&quot;nprocs&quot;</span><span class="p">:</span> <span class="n">nprocs</span><span class="p">,</span>
        <span class="s2">&quot;ntasks&quot;</span><span class="p">:</span> <span class="n">ntasks</span><span class="p">,</span>
        <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">,</span>
        <span class="s2">&quot;charge&quot;</span><span class="p">:</span> <span class="n">charge</span><span class="p">,</span>
        <span class="s2">&quot;multiplicity&quot;</span><span class="p">:</span> <span class="n">multiplicity</span><span class="p">,</span>
        <span class="s2">&quot;redundancy&quot;</span><span class="p">:</span> <span class="n">redundancy</span><span class="p">,</span>
        <span class="s2">&quot;unique_name&quot;</span><span class="p">:</span> <span class="n">unique_name</span><span class="p">,</span>
        <span class="s2">&quot;previous&quot;</span><span class="p">:</span> <span class="n">previous</span><span class="p">,</span>
        <span class="s2">&quot;mem&quot;</span><span class="p">:</span> <span class="n">mem</span><span class="p">,</span>
        <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
        <span class="s2">&quot;xhost&quot;</span><span class="p">:</span> <span class="n">xhost</span><span class="p">,</span>
        <span class="s2">&quot;allocation&quot;</span><span class="p">:</span> <span class="n">allocation</span><span class="p">,</span>
        <span class="s2">&quot;skip_ompi&quot;</span><span class="p">:</span> <span class="n">skip_ompi</span><span class="p">,</span>
        <span class="s2">&quot;prebash&quot;</span><span class="p">:</span> <span class="n">prebash</span><span class="p">,</span>
        <span class="s2">&quot;postbash&quot;</span><span class="p">:</span> <span class="n">postbash</span>
    <span class="p">}</span>

    <span class="c1"># Determine if we need to pre or post append anything to the</span>
    <span class="c1"># job to be submitted.</span>
    <span class="k">if</span> <span class="n">prebash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prebash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;SQUID_ORCA_PREBASH&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">prebash</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SQUID_ORCA_PREBASH&#39;</span><span class="p">]</span>
            <span class="k">while</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span> <span class="ow">in</span> <span class="n">prebash</span><span class="p">:</span>
                <span class="n">prebash</span> <span class="o">=</span> <span class="n">prebash</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prebash</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">postbash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">postbash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;SQUID_ORCA_POSTBASH&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">postbash</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SQUID_ORCA_POSTBASH&#39;</span><span class="p">]</span>
            <span class="k">while</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span> <span class="ow">in</span> <span class="n">postbash</span><span class="p">:</span>
                <span class="n">postbash</span> <span class="o">=</span> <span class="n">postbash</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">postbash</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">postbash</span>

    <span class="c1"># Robustly find the length of frames.  If it is a generator,</span>
    <span class="c1"># then split it and find that length.  NOTE! This will process</span>
    <span class="c1"># the values, so may be slow.  If the generators are more complex</span>
    <span class="c1"># then the user should use the keyword n_frames and this will</span>
    <span class="c1"># be skipped</span>
    <span class="k">if</span> <span class="n">n_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># In this case, it is a generator</span>
            <span class="n">frames</span><span class="p">,</span> <span class="n">frames_held</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
            <span class="n">n_frames</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">frames_held</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">skip_ompi</span><span class="p">:</span>
        <span class="n">orca_path</span> <span class="o">=</span> <span class="n">get_orca_obj</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orca_path</span> <span class="o">=</span> <span class="n">get_orca_obj</span><span class="p">(</span><span class="n">nprocs</span> <span class="o">*</span> <span class="n">ntasks</span> <span class="o">*</span> <span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">queueing_system</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get_queue_manager</span><span class="p">()</span>

    <span class="c1"># Determine indexing to use here as we generate the orca job files.  These</span>
    <span class="c1"># are essentially the numerical values of jobarray_values.  Afterwards,</span>
    <span class="c1"># ensure jobarray_values corresponds appropriately to this for</span>
    <span class="c1"># jobs.submit_job() so the naming convention is the same.</span>
    <span class="k">if</span> <span class="n">jobarray_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jobarray_values</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobarray_values</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">indexing</span> <span class="o">=</span> <span class="n">jobarray_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indexing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">jobarray_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jobarray_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">jobarray_values</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indexing</span><span class="p">)</span>

    <span class="c1"># In the case that we are not on SLURM, then submit each individual job.</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">queueing_system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;slurm&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">queueing_system</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queue_system</span> <span class="o">=</span> <span class="s2">&quot;Locally run&quot;</span>
        <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Because we are running locally, we will </span><span class="se">\</span>
<span class="s2">serialize job running.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning - </span><span class="si">%s</span><span class="s2"> job array not supported. </span><span class="se">\</span>
<span class="s2">Serializing job submission instead.&quot;</span> <span class="o">%</span> <span class="n">queue_system</span><span class="p">)</span>

        <span class="n">running_jobs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">batch_serial_jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indexing</span><span class="p">,</span> <span class="n">frames</span><span class="p">):</span>
                <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">job</span><span class="p">(</span>
                        <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span> <span class="o">+</span> <span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                        <span class="n">route</span><span class="o">=</span><span class="n">route</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span>
                        <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span> <span class="o">**</span><span class="n">properties</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">running_jobs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indexing</span><span class="p">,</span> <span class="n">frames</span><span class="p">):</span>
                <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">job</span><span class="p">(</span>
                        <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span> <span class="o">+</span> <span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                        <span class="n">route</span><span class="o">=</span><span class="n">route</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span>
                        <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span> <span class="o">**</span><span class="n">properties</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">while</span> <span class="nb">sum</span><span class="p">([</span>
                        <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">is_finished</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">running_jobs</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">batch_serial_jobs</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">running_jobs</span>

    <span class="c1"># Step 1 - we can run orca.job on each frame; HOWEVER, we do so by</span>
    <span class="c1"># requesting the debugger queue.  This way, we only generate the</span>
    <span class="c1"># input scripts.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indexing</span><span class="p">,</span> <span class="n">frames</span><span class="p">):</span>
        <span class="n">job</span><span class="p">(</span><span class="n">run_name</span> <span class="o">+</span> <span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span>
            <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s2">&quot;debugger&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">properties</span><span class="p">)</span>

    <span class="c1"># Step 2 - we generate the jobarray script to run the orca jobs on SLURM.</span>
    <span class="n">job_to_submit</span> <span class="o">=</span> <span class="n">prebash</span>
    <span class="n">job_to_submit</span> <span class="o">+=</span> <span class="n">orca_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/orca/&#39;</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span>\
        <span class="s2">&quot;.$</span><span class="si">{SLURM_ARRAY_TASK_ID}</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span>\
        <span class="s2">&quot;.$</span><span class="si">{SLURM_ARRAY_TASK_ID}</span><span class="s2">.orca &gt; &quot;</span>
    <span class="n">job_to_submit</span> <span class="o">+=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/orca/&#39;</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span>
                      <span class="s2">&quot;.$</span><span class="si">{SLURM_ARRAY_TASK_ID}</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span>
                      <span class="s2">&quot;.$</span><span class="si">{SLURM_ARRAY_TASK_ID}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.out</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="n">job_to_submit</span> <span class="o">+=</span> <span class="n">postbash</span>

    <span class="k">return</span> <span class="n">jobs</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span>
        <span class="n">run_name</span><span class="p">,</span> <span class="n">job_to_submit</span><span class="p">,</span>
        <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">mem</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">walltime</span><span class="p">,</span> <span class="n">xhosts</span><span class="o">=</span><span class="n">xhost</span><span class="p">,</span>
        <span class="n">unique_name</span><span class="o">=</span><span class="n">unique_name</span><span class="p">,</span> <span class="n">redundancy</span><span class="o">=</span><span class="n">redundancy</span><span class="p">,</span>
        <span class="n">sandbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_NBS_sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">allocation</span><span class="o">=</span><span class="n">allocation</span><span class="p">,</span>
        <span class="n">jobarray</span><span class="o">=</span><span class="n">jobarray_values</span><span class="p">,</span>
        <span class="n">outfile_name</span><span class="o">=</span><span class="s2">&quot;orca/&quot;</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span> <span class="s2">&quot;.</span><span class="si">%a</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span> <span class="s2">&quot;.</span><span class="si">%a</span><span class="s2">.o%j&quot;</span>
    <span class="p">)</span></div>


<span class="c1"># A function to run an Orca DFT Simulation</span>
<div class="viewcode-block" id="job"><a class="viewcode-back" href="../../../module_docs/orca/job.html#squid.orca.job.job">[docs]</a><span class="k">def</span> <span class="nf">job</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">route</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="p">[],</span> <span class="n">extra_section</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="s2">&quot;00:30:00&quot;</span><span class="p">,</span> <span class="n">sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">redundancy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_NBS_sandbox</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">previous</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xhost</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">allocation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_ompi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prebash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">postbash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper to submitting an Orca simulation.</span>

<span class="sd">    **Parameters**</span>

<span class="sd">        run_name: *str*</span>
<span class="sd">            Name of the simulation to be run.</span>
<span class="sd">        route: *str, optional*</span>
<span class="sd">            The DFT route line, containing the function, basis set, etc.</span>
<span class="sd">            Note, if route=None and previous != None, the route from</span>
<span class="sd">            the previous simulation will be used instead.</span>
<span class="sd">        atoms: *list,* :class:`squid.structures.atom.Atom` *,optional*</span>
<span class="sd">            A list of atoms for the simulation.  If this is an empty list, but</span>
<span class="sd">            previous is used, then the last set of atomic coordinates from</span>
<span class="sd">            the previous simulation will be used.</span>
<span class="sd">        extra_section: *str, optional*</span>
<span class="sd">            Additional DFT simulation parameters.  If None and previous is</span>
<span class="sd">            not None, then previous extra section is used.</span>
<span class="sd">        grad: *bool, optional*</span>
<span class="sd">            Whether to force RunTyp Gradient.</span>
<span class="sd">        queue: *str, optional*</span>
<span class="sd">            What queue to run the simulation on (queueing system dependent).</span>
<span class="sd">        walltime: *str, optional*</span>
<span class="sd">            The walltime the job is given when submitted to a queue.  Format</span>
<span class="sd">            is in day-hr:min:sec.</span>
<span class="sd">        sandbox: *bool, optional*</span>
<span class="sd">            Whether to run the job in a sandbox or not.</span>
<span class="sd">        nprocs: *int, optional*</span>
<span class="sd">            How many processors to run the simulation on.  Note, the actual</span>
<span class="sd">            number requested by orca will be nprocs * ntasks.</span>
<span class="sd">        ntasks: *int, optional*</span>
<span class="sd">            (For SLURM) The number of tasks this job will run, each task uses</span>
<span class="sd">            nprocs number of cores.  Note, the actual number requested by orca</span>
<span class="sd">            will be nprocs * ntasks.</span>
<span class="sd">        nodes: *int, optional*</span>
<span class="sd">            (For SLURM) The number of nodes this job requires.  If requesting</span>
<span class="sd">            ntasks * nprocs &lt; 24 * nodes, a warning is printed, as on MARCC</span>
<span class="sd">            each node has only 24 cores.</span>
<span class="sd">        charge: *int, optional*</span>
<span class="sd">            Charge of the system.  The default charge of 0 is used.</span>
<span class="sd">        multiplicity: *int, optional*</span>
<span class="sd">            Multiplicity of the system.  The default multiplicity of 1 is</span>
<span class="sd">            used.  Recall, multiplicity M = 2*S + 1 where S is the total system</span>
<span class="sd">            spin.</span>
<span class="sd">        redundancy: *bool, optional*</span>
<span class="sd">            With redundancy on, if the job is submitted and unique_name is on,</span>
<span class="sd">            then if another job of the same name is running, a pointer to that</span>
<span class="sd">            job will instead be returned.</span>
<span class="sd">        use_NBS_sandbox: *bool, optional*</span>
<span class="sd">            Whether to use the NBS sandboxing headers (True), or manually copy</span>
<span class="sd">            files (False).</span>
<span class="sd">        unique_name: *bool, optional*</span>
<span class="sd">            Whether to force the requirement of a unique name or not.  NOTE! If</span>
<span class="sd">            you submit simulations from the same folder, ensure that this is</span>
<span class="sd">            True lest you have a redundancy problem! To overcome said issue,</span>
<span class="sd">            you can set redundancy to True as well (but only if the simulation</span>
<span class="sd">            is truly redundant).</span>
<span class="sd">        previous: *str, optional*</span>
<span class="sd">            Name of a previous simulation for which to try reading in</span>
<span class="sd">            information using the MORead method.</span>
<span class="sd">        mem: *float, optional*</span>
<span class="sd">            Amount of memory per processor that is available (in MB).</span>
<span class="sd">        priority: *int, optional*</span>
<span class="sd">            Priority of the simulation (queueing system dependent).  Priority</span>
<span class="sd">            ranges (in NBS) from a low of 1 (start running whenever) to a</span>
<span class="sd">            high of 255 (start running ASAP).</span>
<span class="sd">        xhost: *list, str or str, optional*</span>
<span class="sd">            Which processor to run the simulation on(queueing system</span>
<span class="sd">            dependent).</span>
<span class="sd">        allocation: *str, optional*</span>
<span class="sd">            Whether to use a slurm allocation for this job or not.  If so,</span>
<span class="sd">            specify the name.</span>
<span class="sd">        skip_ompi: *bool, optional*</span>
<span class="sd">            At times you may wish to run orca without checking if ompi is</span>
<span class="sd">            available.  This can arise when you are submitting the job to</span>
<span class="sd">            a queueing system that will load ompi later, but right now you</span>
<span class="sd">            only have orca in the path.  If so, set skip_ompi=True.</span>
<span class="sd">        prebash: *str, optional*</span>
<span class="sd">            Code to put prior to the job_to_submit in the submission script.</span>
<span class="sd">            This should be bash code!  Note, if nothing is passed we check if</span>
<span class="sd">            a default is specified in SQUID_ORCA_PREBASH.</span>
<span class="sd">        postbash: *str, optional*</span>
<span class="sd">            Code to put after the job_to_submit in the submission script.</span>
<span class="sd">            This should be bash code!  Note, if nothing is passed we check if</span>
<span class="sd">            a default is specified in SQUID_ORCA_POSTBASH.</span>

<span class="sd">    **Returns**</span>

<span class="sd">        job: :class:`squid.jobs.container.JobObject`</span>
<span class="sd">            Teturn the job container.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">any</span><span class="p">([</span><span class="n">route</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]),</span>\
        <span class="s2">&quot;Error - You must specify ate least one: route, previous.&quot;</span>

    <span class="c1"># Determine if we need to pre or post append anything to the</span>
    <span class="c1"># job to be submitted.</span>
    <span class="k">if</span> <span class="n">prebash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prebash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;SQUID_ORCA_PREBASH&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">prebash</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SQUID_ORCA_PREBASH&#39;</span><span class="p">]</span>
            <span class="k">while</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span> <span class="ow">in</span> <span class="n">prebash</span><span class="p">:</span>
                <span class="n">prebash</span> <span class="o">=</span> <span class="n">prebash</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prebash</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">postbash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">postbash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;SQUID_ORCA_POSTBASH&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">postbash</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SQUID_ORCA_POSTBASH&#39;</span><span class="p">]</span>
            <span class="k">while</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span> <span class="ow">in</span> <span class="n">postbash</span><span class="p">:</span>
                <span class="n">postbash</span> <span class="o">=</span> <span class="n">postbash</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">postbash</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">postbash</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="ow">and</span> <span class="n">queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Job name </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> too long (</span><span class="si">%d</span><span class="s2">) for NBS. </span><span class="se">\</span>
<span class="s2">Max character length is 31.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_name</span><span class="p">)))</span>

    <span class="c1"># Generate the orca input file folder location</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir -p orca/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot; opt &quot;</span> <span class="ow">in</span> <span class="n">route</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING - Attempting Opt job in system of only 1 atom. </span><span class="se">\</span>
<span class="s2">Switching to Single Point.&quot;</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;opt&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Swapping </span><span class="si">%s</span><span class="s2"> for SP&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SP&quot;</span>
                <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;opt&quot;</span><span class="p">):</span>
                    <span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;opt&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;SCF&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Removing </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xx</span><span class="p">))</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span>
            <span class="n">route</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># Get the orca path</span>
    <span class="k">if</span> <span class="n">skip_ompi</span><span class="p">:</span>
        <span class="n">orca_path</span> <span class="o">=</span> <span class="n">get_orca_obj</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orca_path</span> <span class="o">=</span> <span class="n">get_orca_obj</span><span class="p">(</span><span class="n">nprocs</span> <span class="o">*</span> <span class="n">ntasks</span> <span class="o">*</span> <span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">queueing_system</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get_queue_manager</span><span class="p">()</span>

    <span class="n">nprocs</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nprocs</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ntasks</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">cores_to_use</span> <span class="o">=</span> <span class="n">nprocs</span> <span class="o">*</span> <span class="n">ntasks</span>

    <span class="c1"># Handle issue with nprocs vs ntasks</span>
    <span class="k">if</span> <span class="n">queueing_system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">queueing_system</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span> <span class="ow">and</span> \
            <span class="n">cores_to_use</span> <span class="o">&gt;</span> <span class="n">ntasks</span><span class="p">:</span>
        <span class="c1"># An issue due to &quot;Slots&quot; being allocated whenever ntasks is</span>
        <span class="c1"># specified, but not when nprocs is specified.</span>
        <span class="c1"># Instead of throwing an error, we fix it manually here</span>
        <span class="k">if</span> <span class="n">nprocs</span> <span class="o">&gt;</span> <span class="n">ntasks</span><span class="p">:</span>
            <span class="n">ntasks</span><span class="p">,</span> <span class="n">nprocs</span> <span class="o">=</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">ntasks</span>

        <span class="c1"># If we find that we still have too many requested,</span>
        <span class="c1"># then throw the error</span>
        <span class="k">if</span> <span class="n">cores_to_use</span> <span class="o">&gt;</span> <span class="n">ntasks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error - When using slurm, you must specify </span><span class="se">\</span>
<span class="s2">ntasks instead of nprocs for number of cores to use.&quot;</span><span class="p">)</span>

    <span class="c1"># Handle previous</span>
    <span class="k">if</span> <span class="n">route</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="n">orca_io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span><span class="o">.</span><span class="n">route</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">extra_section</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extra_section</span> <span class="o">=</span> <span class="n">orca_io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span><span class="o">.</span><span class="n">extra_section</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># If we read in the previous extra_section, remove the number of cores</span>
        <span class="k">if</span> <span class="s2">&quot;%pal nprocs&quot;</span> <span class="ow">in</span> <span class="n">extra_section</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">extra_section</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;%pal&quot;</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;end&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">extra_section</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

    <span class="c1"># orca requires route line to start with &quot;!&quot;</span>
    <span class="k">if</span> <span class="n">route</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;!&quot;</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;! &#39;</span> <span class="o">+</span> <span class="n">route</span>

    <span class="c1"># Add moread if a previous orca job was provided</span>
    <span class="k">if</span> <span class="n">previous</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;moread&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">route</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">route</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; MORead&#39;</span>
        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="c1"># Accept absolute paths</span>
        <span class="k">if</span> <span class="n">previous</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">previous_path</span> <span class="o">=</span> <span class="n">previous</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_path</span> <span class="o">=</span> <span class="n">current_dir</span> <span class="o">+</span> <span class="s1">&#39;/orca/&#39;</span> <span class="o">+</span> <span class="n">previous</span>
            <span class="n">previous_path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">previous</span> <span class="o">+</span> <span class="s1">&#39;.orca.gbw&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">previous_path</span><span class="p">):</span>
                <span class="n">test_path</span> <span class="o">=</span> <span class="n">current_dir</span> <span class="o">+</span> <span class="s1">&#39;/orca/&#39;</span> <span class="o">+</span> <span class="n">previous</span>
                <span class="n">test_path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">previous</span> <span class="o">+</span> <span class="s1">&#39;.orca.proc0.gbw&#39;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">test_path</span><span class="p">):</span>
                    <span class="n">previous_path</span> <span class="o">=</span> <span class="n">test_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">previous_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Previous run does not have a .gbw file at </span><span class="si">%s</span><span class="s2">.&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">previous_path</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">previous_path</span><span class="p">,</span> <span class="s1">&#39;orca/</span><span class="si">%s</span><span class="s1">/previous.gbw&#39;</span> <span class="o">%</span> <span class="n">run_name</span><span class="p">)</span>

        <span class="c1"># First, if moinp is already in extra_section, remove it</span>
        <span class="n">check_str</span> <span class="o">=</span> <span class="s1">&#39;%moinp &quot;previous.gbw&quot;&#39;</span>
        <span class="k">if</span> <span class="n">check_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_section</span><span class="p">:</span>
            <span class="n">extra_section</span> <span class="o">=</span> <span class="n">extra_section</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">%moinp &quot;previous.gbw&quot;&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;%moinp&#39;</span> <span class="ow">in</span> <span class="n">extra_section</span> <span class="ow">and</span> <span class="n">check_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_section</span><span class="p">:</span>
            <span class="c1"># TODO - Just remove %moinp &quot;whatever.gbw&quot; from the extra_section</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error - moinp encountered, but not as </span><span class="se">\</span>
<span class="s2">previous.gbw.  If you wish to continue, then don&#39;t specify previous.&quot;</span><span class="p">)</span>

        <span class="c1"># If no atoms were specified, get the atoms from the previous job</span>
        <span class="k">if</span> <span class="n">atoms</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">old_name</span> <span class="o">=</span> <span class="n">previous_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.orca.gbw&#39;</span><span class="p">,</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>
            <span class="n">old_name</span> <span class="o">=</span> <span class="n">old_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.orca.proc0.gbw&#39;</span><span class="p">,</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>
            <span class="n">old_results</span> <span class="o">=</span> <span class="n">orca_io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
            <span class="c1"># Grab the final frame of previous simulation</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="n">old_results</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># If running on system with more than one core, tell orca</span>
    <span class="k">if</span> <span class="n">cores_to_use</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">add_to_extra</span> <span class="o">=</span> <span class="s1">&#39;%pal nprocs &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cores_to_use</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; end</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">extra_section</span> <span class="o">=</span> <span class="n">add_to_extra</span> <span class="o">+</span> <span class="n">extra_section</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># If desiring .orca.engrad output, tell orca</span>
    <span class="k">if</span> <span class="n">grad</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;RunTyp Gradient&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_section</span><span class="p">:</span>
            <span class="n">extra_section</span> <span class="o">=</span> <span class="n">extra_section</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\n</span><span class="s1">%method</span>
<span class="s1"> RunTyp Gradient</span>
<span class="s1"> end&#39;&#39;&#39;</span>

    <span class="c1"># One can specify how much memory they want (in MB) per core</span>
    <span class="k">if</span> <span class="n">mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extra_section</span> <span class="o">=</span> <span class="n">extra_section</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">extra_section</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">%maxcore &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># If trying to run &quot;Opt&quot; on one atom, this would crash orca</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s2">&quot;opt&quot;</span> <span class="ow">in</span> <span class="n">route</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="c1"># In the case of a simple switch, run it with warning</span>
        <span class="k">if</span> <span class="s2">&quot; opt &quot;</span> <span class="ow">in</span> <span class="n">route</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning - Attempted OPT in Orca for system of less </span><span class="se">\</span>
<span class="s2">than 2 atoms. Auto-swapping Opt for SP.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot; opt &quot;</span><span class="p">,</span> <span class="s2">&quot; Opt &quot;</span><span class="p">,</span> <span class="s2">&quot; OPT &quot;</span><span class="p">]:</span>
                <span class="k">while</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">route</span><span class="p">:</span>
                    <span class="n">route</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot; SP &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Attempting Orca optimization of system with </span><span class="se">\</span>
<span class="s2">less than 2 atoms!&quot;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># NO MORE CHANGES TO EXTRA_SECTION AFTER THIS!-----------------------------</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># Change directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;orca/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_name</span><span class="p">)</span>

    <span class="c1"># Get input for orca formatted correctly</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">extra_section</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">inp</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*xyz &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="n">s_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">extra</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;extra&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">inp</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">s_id</span><span class="p">)</span>
    <span class="n">inp</span> <span class="o">+=</span> <span class="s1">&#39;*</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1"># Write the orca file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_name</span> <span class="o">+</span> <span class="s1">&#39;.orca&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Run the simulation</span>
    <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">orca_path</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.orca &amp; disown&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.out&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">run_name</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.err&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">run_name</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">process_handle</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span>
        <span class="p">)</span>
        <span class="n">job_obj</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">process_handle</span><span class="o">=</span><span class="n">process_handle</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">queue</span> <span class="o">==</span> <span class="s1">&#39;debugger&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Would run </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">run_name</span><span class="p">)</span>
        <span class="n">job_obj</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Details copied from orca for sandbox</span>
        <span class="n">job_to_submit</span> <span class="o">=</span> <span class="n">prebash</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="c1">#if not use_NBS_sandbox:</span>
        <span class="c1">#    job_to_submit += &quot;workdir=$(pwd -P)\n&quot;</span>
        <span class="c1">#    job_to_submit += &quot;thisdir=&quot; + os.getcwd() + &quot;\n&quot;</span>
        <span class="n">job_to_submit</span> <span class="o">+=</span> <span class="n">orca_path</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">job_to_submit</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">run_name</span> <span class="o">+</span> <span class="s2">&quot;.orca &gt; &quot;</span>
        <span class="n">job_to_submit</span> <span class="o">+=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">run_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.out</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="c1">#job_to_submit = job_to_submit + &quot;touch &quot; + run_name + &quot;.orca.xyz\n&quot;</span>
        <span class="c1">#job_to_submit = job_to_submit + &quot;touch &quot; + run_name + &quot;.orca.gbw\n&quot;</span>
        <span class="c1">#job_to_submit = job_to_submit + &quot;touch &quot; + run_name + &quot;.orca.engrad\n&quot;</span>
        <span class="c1">#job_to_submit = job_to_submit + &quot;touch &quot; + run_name + &quot;.orca.prop\n&quot;</span>
        <span class="c1">#job_to_submit = job_to_submit + &quot;touch &quot; + run_name + &quot;.orca.opt\n&quot;</span>
        <span class="n">job_to_submit</span> <span class="o">=</span> <span class="n">job_to_submit</span> <span class="o">+</span> <span class="n">postbash</span>

        <span class="n">sandbox_in</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*.orca*&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;previous.gbw&quot;</span><span class="p">):</span>
            <span class="n">sandbox_in</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;previous.gbw&quot;</span><span class="p">]</span>
        <span class="n">sandbox_out</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*.xyz&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;*.trj&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;*.gbw&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;*.engrad&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;*.prop&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;*.opt&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sandbox</span><span class="p">:</span>
            <span class="n">sandbox</span> <span class="o">=</span> <span class="p">[</span><span class="n">sandbox_in</span><span class="p">,</span> <span class="n">sandbox_out</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sandbox</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">job_obj</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span>
            <span class="n">run_name</span><span class="p">,</span> <span class="n">job_to_submit</span><span class="p">,</span>
            <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">mem</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
            <span class="n">walltime</span><span class="o">=</span><span class="n">walltime</span><span class="p">,</span> <span class="n">xhosts</span><span class="o">=</span><span class="n">xhost</span><span class="p">,</span>
            <span class="n">unique_name</span><span class="o">=</span><span class="n">unique_name</span><span class="p">,</span> <span class="n">redundancy</span><span class="o">=</span><span class="n">redundancy</span><span class="p">,</span>
            <span class="n">sandbox</span><span class="o">=</span><span class="n">sandbox</span><span class="p">,</span> <span class="n">use_NBS_sandbox</span><span class="o">=</span><span class="n">use_NBS_sandbox</span><span class="p">,</span>
            <span class="n">allocation</span><span class="o">=</span><span class="n">allocation</span>
        <span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Copy run script</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s1">&#39;../../</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="c1"># Submitted a job oddly enough that sys.argv[0]</span>
        <span class="c1"># is not the original python file name, so don&#39;t do this</span>
        <span class="k">pass</span>

    <span class="c1"># Return to the appropriate directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../..&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">job_obj</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../squid.html">Squid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../console_scripts.html">Console Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Squid 2.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Henry Herbol.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>