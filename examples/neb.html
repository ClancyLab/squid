
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Nudged Elastic Band Demo &#8212; Squid 2.0.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index_html.html">Squid 2.0.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="nudged-elastic-band-demo">
<h1>Nudged Elastic Band Demo<a class="headerlink" href="#nudged-elastic-band-demo" title="Permalink to this headline">Â¶</a></h1>
<p>The below code shows how one can generate a reaction pathway, and ultimately run NEB on it to find the minimum energy pathway (MEP).  Further, it automates the submission of an eigenvector following Transition State optimization from the peak, and verifies a transition state was found.  Note, the endpoints and NEB should use the same DFT level of theory, otherwise your endpoints may not remain local minima within the potential energy surface.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">squid</span> <span class="kn">import</span> <span class="n">orca</span>
<span class="kn">from</span> <span class="nn">squid</span> <span class="kn">import</span> <span class="n">files</span>
<span class="kn">from</span> <span class="nn">squid</span> <span class="kn">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">squid.calcs</span> <span class="kn">import</span> <span class="n">NEB</span>
<span class="kn">from</span> <span class="nn">squid</span> <span class="kn">import</span> <span class="n">structures</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># In this example we will generate the full CNH-HCN isomerization using</span>
    <span class="c1"># only squid.  Then we optimize the endpoints in DFT, smooth the frames,</span>
    <span class="c1"># and subsequently run NEB</span>

    <span class="c1"># Step 1 - Generate the bad initial guess</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Step 1 - Generate the bad initial guess...&quot;</span><span class="p">)</span>
    <span class="n">H_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">CNH_frames</span> <span class="o">=</span> <span class="p">[[</span>
        <span class="n">structures</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">structures</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">structures</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">H_coords</span>
    <span class="p">]</span>
    <span class="c1"># Save initial frames</span>
    <span class="n">files</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">CNH_frames</span><span class="p">,</span> <span class="s2">&quot;bad_guess.xyz&quot;</span><span class="p">)</span>

    <span class="c1"># Step 2 - Optimize the endpoints</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Step 2 - Optimize endpoints...&quot;</span><span class="p">)</span>
    <span class="n">frame_start_job</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">job</span><span class="p">(</span>
        <span class="s2">&quot;frame_start&quot;</span><span class="p">,</span> <span class="s2">&quot;! HF-3c Opt&quot;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">CNH_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>
    <span class="n">frame_last_job</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">job</span><span class="p">(</span>
        <span class="s2">&quot;frame_last&quot;</span><span class="p">,</span> <span class="s2">&quot;! HF-3c Opt&quot;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">CNH_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>
    <span class="c1"># Wait</span>
    <span class="n">frame_start_job</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">frame_last_job</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="c1"># Step 3 - Read in the final coordiantes, and update the band</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Step 3 - Store better endpoints...&quot;</span><span class="p">)</span>
    <span class="n">CNH_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;frame_start&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">atoms</span>
    <span class="n">CNH_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;frame_last&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">atoms</span>
    <span class="c1"># Save better endpoints</span>
    <span class="n">files</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">CNH_frames</span><span class="p">,</span> <span class="s2">&quot;better_guess.xyz&quot;</span><span class="p">)</span>

    <span class="c1"># Step 4 - Smooth out the band to 10 frames</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Step 4 - Smooth out the band...&quot;</span><span class="p">)</span>
    <span class="n">CNH_frames</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">smooth_xyz</span><span class="p">(</span>
        <span class="n">CNH_frames</span><span class="p">,</span> <span class="n">N_frames</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">use_procrustes</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="c1"># Save smoothed band</span>
    <span class="n">files</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">CNH_frames</span><span class="p">,</span> <span class="s2">&quot;smoothed_guess.xyz&quot;</span><span class="p">)</span>

    <span class="c1"># Step 5 - Run NEB</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Step 5 - Run NEB...&quot;</span><span class="p">)</span>
    <span class="n">neb_handle</span> <span class="o">=</span> <span class="n">NEB</span><span class="p">(</span>
        <span class="s2">&quot;CNH&quot;</span><span class="p">,</span> <span class="n">CNH_frames</span><span class="p">,</span> <span class="s2">&quot;! HF-3c&quot;</span><span class="p">,</span>
        <span class="n">procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ci_neb</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">CNH_frames</span> <span class="o">=</span> <span class="n">neb_handle</span><span class="o">.</span><span class="n">optimize</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Save final band</span>
    <span class="n">files</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">CNH_frames</span><span class="p">,</span> <span class="s2">&quot;final.xyz&quot;</span><span class="p">)</span>

    <span class="c1"># Step 6 - Isolate the peak frame, and converge to the transition state</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Step 6 - Calculating Transition State...&quot;</span><span class="p">)</span>
    <span class="n">ts_job</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">job</span><span class="p">(</span>
        <span class="s2">&quot;CNH_TS&quot;</span><span class="p">,</span> <span class="s2">&quot;! HF-3c OptTS NumFreq&quot;</span><span class="p">,</span>
        <span class="n">extra_section</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="si">%g</span><span class="s1">eom</span>
<span class="s1">    Calc_Hess true</span>
<span class="s1">    NumHess true</span>
<span class="s1">    Recalc_Hess 5</span>
<span class="s1">    end</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span>
        <span class="n">atoms</span><span class="o">=</span><span class="n">CNH_frames</span><span class="p">[</span><span class="n">neb_handle</span><span class="o">.</span><span class="n">highest_energy_frame_index</span><span class="p">],</span> <span class="n">queue</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>
    <span class="n">ts_job</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="c1"># Ensure we did find the transition state</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;CNH_TS&quot;</span><span class="p">)</span>
    <span class="n">vib_freq</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">vibfreq</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vib_freq</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;    Isolated a transition state with exactly 1 negative vibfreq.&quot;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;    Saving it to CNH_ts.xyz&quot;</span><span class="p">)</span>
        <span class="n">files</span><span class="o">.</span><span class="n">write_xyz</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="s2">&quot;CNH_ts.xyz&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;FAILED!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Example output is as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>------------------------------------------------------------------------------------------
Run_Name = CNH
DFT Package = orca
Spring Constant for NEB: 0.00367453 Ha/Ang = 0.1 eV/Ang
Running Climbing Image, starting at iteration 5

Running neb with optimization method LBFGS
    step_size = 1
    step_size_adjustment = 0.5
    max_step = 0.04
    Using numerical optimization starting hessian approximation.
    Will reset stored parameters and gradients when stepped bad.
    Will reset step_size after 20 good steps.
    Will accelerate step_size after 20 good steps.
    Will use procrustes to remove rigid rotations and translations
Convergence Criteria:
    g_rms = 0.001 (Ha/Ang) = 0.0272144 (eV/Ang)
    g_max = 0.001 (Ha/Ang) = 0.0272144 (eV/Ang)
    maxiter = 1000
---------------------------------------------
Step    RMS_F (eV/Ang)  MAX_F (eV/Ang)  MAX_E (kT_300)  Energies (kT_300)
----
0   28.7949     44.5242     223.9       -92.232 + 109.6 215.5 223.9 182.8  62.4  62.4 -24.8
1   15.339      21.7786     161.1       -92.232 +  44.3 143.0 161.1  88.4  13.7  20.3 -24.8
2   14.6517     20.8575     158.0       -92.232 +  41.7 139.4 158.0  86.2  11.9  17.2 -24.8
3   6.0258      9.376       122.9       -92.232 +  15.2 100.8 122.9  62.8  -5.4  -9.2 -24.8
4   5.6856      8.8098      121.5       -92.232 +  14.5  99.4 121.5  61.5  -5.7  -9.3 -24.8
5   1.8606      3.0362      107.7       -92.232 +   9.4  86.9 107.7  50.6  -8.2 -10.1 -24.8
6   1.1459      3.024       105.3       -92.232 +   9.3  85.5 105.3  49.1  -8.4 -11.0 -24.8
7   0.945       2.5354      105.2       -92.232 +   9.4  84.9 105.2  48.5  -8.5 -11.3 -24.8
8   0.9274      2.0697      107.9       -92.232 +   9.5  84.5 107.9  48.8  -8.5 -11.9 -24.8
9   0.8502      1.9055      110.2       -92.232 +   9.4  84.5 110.2  49.1  -8.6 -12.3 -24.8
10  0.9637      1.7608      114.3       -92.232 +   9.5  85.0 114.3  49.5  -8.4 -13.0 -24.8
11  0.8564      1.4446      115.4       -92.232 +   9.5  84.9 115.4  49.4  -8.4 -13.4 -24.8
12  0.8252      1.2095      116.8       -92.232 +   9.7  84.6 116.8  49.6  -8.2 -14.5 -24.8
13  0.3625      0.742       115.6       -92.232 +   9.6  84.2 115.6  49.3  -8.4 -14.3 -24.8
14  0.8296      1.4249      116.8       -92.232 +   9.9  84.3 116.8  49.9  -8.1 -15.6 -24.8
15  0.6218      1.0318      116.8       -92.232 +   9.8  84.2 116.8  49.8  -8.2 -15.6 -24.8
16  0.2493      0.5738      116.4       -92.232 +   9.7  83.9 116.4  49.6  -8.2 -15.2 -24.8
17  0.1849      0.3175      116.4       -92.232 +   9.7  83.9 116.4  49.6  -8.2 -15.1 -24.8
18  0.1046      0.2349      116.3       -92.232 +   9.8  83.8 116.3  49.7  -8.2 -15.1 -24.8
19  0.0459      0.1069      116.3       -92.232 +   9.8  83.8 116.3  49.7  -8.1 -15.1 -24.8
20  0.0221      0.0458      116.3       -92.232 +   9.8  83.7 116.3  49.7  -8.1 -15.1 -24.8

NEB converged the RMS force.
------------------------------------------------------------------------------------------
</pre></div>
</div>
<p>With the following graph made using the scanDFT command line tool:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>scanDFT CNH-20-%d 1 6 -neb CNH-0-0,CNH-0-7 -t &quot;NEB of CNH Isomerization&quot; -lx &quot;Reaction Coordinate&quot; -ly &quot;Energy&quot; -u eV
</pre></div>
</div>
<img alt="../_images/zoomed_plot_scaled.png" src="../_images/zoomed_plot_scaled.png" />
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index_html.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../squid.html">Squid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../console_scripts.html">Console Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples/neb.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index_html.html">Squid 2.0.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Henry Herbol.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>